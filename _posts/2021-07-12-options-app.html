<div>
  <ol id="list"><li><span style="width:100px; display:inline-block;">Symbol</span><span style="width:100px; display:inline-block;">Price</span><span style="width:100px; display:inline-block;">Strike</span><span style="width:100px; display:inline-block;">lastPrice</span><span style="width:100px; display:inline-block;">style</span><span style="width:100px; display:inline-block;">Distance(%)</span><span style="width:100px; display:inline-block;">Return(%)</span><span style="width:100px; display:inline-block;">Week</span>
</li></ol>

</div>
<script>
  
  function within_two_weeks(unix_time) {
    let now = Date.now();
    return (unix_time - now/1000 < 15*24*60*60);
  }
  
  function date_diff(unix_time) {
    let now = Date.now();
    return (Math.floor((unix_time - now/1000)/(24*60*60)) + 1);
  }

  var allData = {};
  var filterData = [];
  var record = [];
  var recordLength = 5;
  var price = 0;
  var strike = 0;
  
                         
  var option_symbols = ['amc', 'intc'];
  var base_url = 'https://query2.finance.yahoo.com/v7/finance/options/';
  
  var promises = [];  
  
  
//******* Fetch data *****
for (let i = 0; i < option_symbols.length; i++) {
    allData[option_symbols[i]] = [];
    promises.push (  
      fetch("https://ansyble.herokuapp.com/cors/", {headers: {'Target-URL':base_url + option_symbols[i]}, cache:'no-cache'}).then(function(response) {
          return response.json();
      }).then(function(data) {
          allData[option_symbols[i]].push(data.optionChain.result[0]);
          //console.log(allData[option_symbols[i]][0]);

          let promises2 = [];
          for (let j = 1; j < allData[option_symbols[i]][0].expirationDates.length; j++) {
              if (within_two_weeks(allData[option_symbols[i]][0].expirationDates[j])) {
                  promises2.push( 
                    fetch("https://ansyble.herokuapp.com/cors/", 
                    {headers: {'Target-URL':base_url + option_symbols[i] + "?date=" + allData[option_symbols[i]][0].expirationDates[j]}, 
                    cache:'no-cache'}).then(function(response) {
                        return response.json();
                    }).then(function(remainingData) {
                        allData[option_symbols[i]].push(remainingData.optionChain.result[0]);
                        console.log(allData[option_symbols[i]][j]);
                    })
                 );
              }                                                                  
          }
          return Promise.all(promises2);
      }) 
    );
}


//***** Create filter daa *****
var recordSize = 0;
var distance = 0;
var aprReturn = 0;
Promise.all(promises).then(function() {  
    for (let symbol in allData) {   	
      price = allData[symbol][0].quote.regularMarketPrice; 
    	for(var week=0;week<allData[symbol].length;week++){   	
        console.log("expiration week : " , week+1);
        dateDiff = date_diff(allData[symbol][week].options[0].calls[0].expiration);
        recordSize = 0;
        for(var call=0;call<allData[symbol][week].options[0].calls.length;call++){
        	record = [];
        	record.push(symbol);
          record.push(price);
          record.push(allData[symbol][week].options[0].calls[call].strike);
          record.push(allData[symbol][week].options[0].calls[call].lastPrice);
          record.push('call');
          distance = ((allData[symbol][week].options[0].calls[call].strike-price)/price)*100;
          distance = distance.toFixed(2);
          record.push(distance);
          
          aprReturn = (((allData[symbol][week].options[0].calls[call].lastPrice/allData[symbol][week].options[0].calls[call].strike)/dateDiff)*250)*100;
          aprReturn = aprReturn.toFixed(2);
          record.push(aprReturn);
          
          record.push(week+1);
          
         
          lastTradeDateFromNow = date_diff(allData[symbol][week].options[0].calls[call].lastTradeDate);
          console.log('lastTradeDateFromNow = ',lastTradeDateFromNow);
  				if (allData[symbol][week].options[0].calls[call].volume > volumeMin &&  
          	allData[symbol][week].options[0].calls[call].bid > bidMin &&
            lastTradeDateFromNow > lastTradeDateMin &&
            distance > distanceMin && aprReturn > aprReturnMin) {
              filterData.push(record);
              recordSize++;
        }
        //console.log("symbol : " + symbol + ", call record size = " + recordSize);
        
        recordSize = 0;
        for(var put=0;put<allData[symbol][week].options[0].puts.length;put++){
          record = [];
        	record.push(symbol);
          record.push(price);
          record.push(allData[symbol][week].options[0].puts[put].strike);
          record.push(allData[symbol][week].options[0].puts[put].lastPrice);
          record.push('put')
          distance = ((price-allData[symbol][week].options[0].puts[put].strike)/price)*100;
          distance = distance.toFixed(2);
          record.push(distance);
          
          aprReturn = (((allData[symbol][week].options[0].puts[put].lastPrice/allData[symbol][week].options[0].puts[put].strike)/dateDiff)*250)*100;
          aprReturn = aprReturn.toFixed(2);
          record.push(aprReturn);
          
          record.push(week+1);
          filterData.push(record);
          recordSize++;
        }
        //console.log("symbol : " + symbol + ", put record size = " + recordSize);
      }
    }
    
    

 
 
 
for(let i = 0; i < filterData.length; i++) {

let first = document.createElement('span');
let second = document.createElement('span');
let third = document.createElement('span');
let fourth = document.createElement('span');
let fifth = document.createElement('span');
let sixth = document.createElement('span');
let seventh = document.createElement('span');

first.style.display = "inline-block";
second.style.display = "inline-block";
third.style.display = "inline-block";
fourth.style.display = "inline-block";
fifth.style.display = "inline-block";
sixth.style.display = "inline-block";
seventh.style.display = "inline-block";

first.style.width = "100px";
second.style.width = "100px";
third.style.width = "100px";
fourth.style.width = "100px";
fifth.style.width = "100px";
sixth.style.width = "100px";
seventh.style.width = "100px";

first.textContent = filterData[i][0];
second.textContent = filterData[i][1];
third.textContent = filterData[i][2];
fourth.textContent = filterData[i][3];
fifth.textContent = filterData[i][4];
sixth.textContent = filterData[i][5];
seventh.textContent = filterData[i][6];

let li = document.createElement("li");
li.appendChild(first);
li.appendChild(second);
li.appendChild(third);
li.appendChild(fourth);
li.appendChild(fifth);
li.appendChild(sixth);
li.appendChild(seventh);

let eighth = document.createElement('span');
eighth.style.display = "inline-block";
eighth.style.width = "100px";
eighth.textContent = filterData[i][7];
li.appendChild(eighth);

document.getElementById('list').appendChild(li);
}

 });
    
                                                                 
</script>
